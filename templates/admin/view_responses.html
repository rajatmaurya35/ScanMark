{% extends "admin/base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Session Responses</h2>
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
        </a>
    </div>

    <div class="card mb-4">
        <div class="card-header" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white;">
            <h5 class="mb-0">Session Details</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <p class="mb-1"><strong>Subject:</strong> {{ session.name }}</p>
                </div>
                <div class="col-md-3">
                    <p class="mb-1"><strong>Faculty:</strong> {{ session.faculty }}</p>
                </div>
                <div class="col-md-3">
                    <p class="mb-1"><strong>Branch:</strong> {{ session.branch }}</p>
                </div>
                <div class="col-md-3">
                    <p class="mb-1"><strong>Semester:</strong> {{ session.semester }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white;">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Attendance Records</h5>
                <button class="btn btn-light btn-sm" onclick="exportToCSV()">
                    <i class="fas fa-download me-2"></i>Export CSV
                </button>
            </div>
        </div>
        <div class="card-body">
            {% if responses %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Student Name</th>
                            <th>Student ID</th>
                            <th>Timestamp</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for response in responses %}
                        <tr>
                            <td>{{ response.student_name }}</td>
                            <td>{{ response.student_id }}</td>
                            <td>{{ response.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                            <td>
                                <span class="badge bg-success">Present</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="text-muted mt-3">
                Total Responses: {{ responses|length }}
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-clipboard-list text-muted" style="font-size: 48px;"></i>
                <h4 class="mt-3">No Responses Yet</h4>
                <p class="text-muted">Responses will appear here once students mark their attendance.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function exportToCSV() {
    const responses = {{ responses|tojson }};
    if (!responses || responses.length === 0) {
        alert('No data to export');
        return;
    }
    
    // Prepare CSV content
    const headers = ['Student Name', 'Student ID', 'Timestamp', 'Status'];
    const rows = responses.map(r => [
        r.student_name,
        r.student_id,
        new Date(r.timestamp).toLocaleString(),
        'Present'
    ]);
    
    // Convert to CSV
    const csvContent = [
        headers.join(','),
        ...rows.map(row => row.join(','))
    ].join('\n');
    
    // Create download link
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('href', url);
    a.setAttribute('download', `attendance_${new Date().toISOString().split('T')[0]}.csv`);
    a.click();
    window.URL.revokeObjectURL(url);
}
</script>
{% endblock %}
